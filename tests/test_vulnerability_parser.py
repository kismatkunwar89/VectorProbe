"""
Unit tests for vulnerability_parser.py

Run:
    pytest -q
"""

import json
from pathlib import Path

from src.parsers.vulnerability_parser import (
    parse_searchsploit_json,
    extract_search_keywords
)


def test_parse_searchsploit_json_fixture():
    """
    Ensure the parser loads exploit entries from a known fixture.
    """
    fixture_path = Path("tests/fixtures/searchsploit.json")
    raw = json.loads(fixture_path.read_text(encoding="utf-8"))

    exploits = parse_searchsploit_json(raw)

    # Basic checks
    assert isinstance(exploits, list)
    assert len(exploits) == 1

    e = exploits[0]
    assert e["title"] == "OpenSSH 7.2p2 - Username Enumeration"
    assert e["edb_id"] == "40136"
    assert e["platform"] == "linux"
    assert e["path"].endswith(".py")
    assert e["url"].startswith("https://")


def test_keyword_filtering_reduces_noise():
    """Ensure keyword filtering keeps only relevant exploit entries."""
    raw = {
        "RESULTS_EXPLOIT": [
            {
                "Title": "Microsoft HTTPAPI WinRM Authentication Bypass",
                "EDB-ID": "99999",
                "Path": "windows/remote/99999.txt"
            },
            {
                "Title": "Generic HTTP Server Reflected XSS",
                "EDB-ID": "11111",
                "Path": "php/webapps/11111.txt"
            }
        ]
    }

    query = "Microsoft HTTPAPI httpd 2.0"
    keywords = extract_search_keywords(query)
    exploits = parse_searchsploit_json(raw, query=query, keywords=keywords)

    assert len(exploits) == 1
    assert exploits[0]["edb_id"] == "99999"
