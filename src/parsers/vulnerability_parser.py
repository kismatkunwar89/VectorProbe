"""
vulnerability_parser.py

Responsible for:
- Parsing the JSON output from: searchsploit --json <query>
- Normalizing it into a consistent list of exploit dictionaries

Why normalize?
- searchsploit output keys vary a bit depending on version/platform
- report_generator should not care about format differences
"""

from __future__ import annotations

from typing import Any, Dict, List


def _normalize_item(item: Dict[str, Any]) -> Dict[str, Any]:
    """
    Normalize an exploit record into consistent keys.

    We support common keys seen in searchsploit JSON output:
    - Title / EDB-ID / Date / Author / Type / Platform / Path / URL
    """
    return {
        "title": item.get("Title") or item.get("title") or "",
        "edb_id": item.get("EDB-ID") or item.get("edb_id") or item.get("id") or "",
        "date": item.get("Date") or item.get("date") or "",
        "author": item.get("Author") or item.get("author") or "",
        "type": item.get("Type") or item.get("type") or "",
        "platform": item.get("Platform") or item.get("platform") or "",
        "path": item.get("Path") or item.get("path") or "",
        "url": item.get("URL") or item.get("url") or "",
    }


def parse_searchsploit_json(raw_json: Dict[str, Any]) -> List[Dict[str, Any]]:
    """
    Parse searchsploit JSON output into a flat list of normalized exploits.

    Common formats include:
    A) {"RESULTS_EXPLOIT":[{...}], "RESULTS_SHELLCODE":[...]}
    B) {"results":{"exploit":[...], "shellcode":[...]}}
    C) {"EXPLOITS":[...]}  (varies)

    Returns:
        A list of dicts like:
        [
          {"title": "...", "edb_id": "...", "path": "...", "url": "...", ...},
          ...
        ]
    """
    if not raw_json:
        return []

    items: List[Dict[str, Any]] = []

    # --- Format A ---
    if isinstance(raw_json.get("RESULTS_EXPLOIT"), list):
        items.extend(raw_json["RESULTS_EXPLOIT"])

    if isinstance(raw_json.get("RESULTS_SHELLCODE"), list):
        items.extend(raw_json["RESULTS_SHELLCODE"])

    # --- Format B ---
    results = raw_json.get("results")
    if isinstance(results, dict):
        for key in ("exploit", "exploits", "shellcode"):
            arr = results.get(key)
            if isinstance(arr, list):
                items.extend(arr)

    # --- Format C ---
    for key in ("EXPLOITS", "exploits"):
        arr = raw_json.get(key)
        if isinstance(arr, list):
            items.extend(arr)

    # Normalize all dict items
    normalized: List[Dict[str, Any]] = []
    for item in items:
        if isinstance(item, dict):
            normalized.append(_normalize_item(item))

    # Deduplicate (avoid repeated results)
    seen = set()
    unique: List[Dict[str, Any]] = []
    for e in normalized:
        key = (e.get("title", ""), e.get("path", ""), e.get("edb_id", ""))
        if key not in seen:
            seen.add(key)
            unique.append(e)

    return unique
