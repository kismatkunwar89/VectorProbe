
import json
import shutil
import subprocess
import re
from dataclasses import dataclass
from typing import Dict, List


@dataclass
class SearchsploitResult:
    """
    Stores the result of a searchsploit command.
    """
    command: str
    raw_json: Dict
    stdout: str
    stderr: str
    exit_code: int


class VulnerabilityHandler:
    """
    Handles vulnerability lookup using searchsploit.
    Smart filtering to avoid noise (SSH clients, unrelated results).
    """

    def __init__(self, timeout_sec: int = 60):
        self.timeout_sec = timeout_sec

    def _ensure_searchsploit_exists(self):
        """
        Ensure searchsploit is installed and accessible.
        """
        if shutil.which("searchsploit") is None:
            raise RuntimeError(
                "searchsploit is not installed or not in PATH."
            )

    def _filter_noise(self, exploits: List[Dict]) -> List[Dict]:
        """Filter out irrelevant SSH results (clients, unrelated CVEs)."""
        noise_keywords = [
            "client",
            "putty",
            "teraterm",
            "securecrt",
            "winscp",
            "filezilla",
            "chrome",
            "browser",
            "webmail",
            "google",
            "microsoft",
            "symantec",
            "kaspersky",
            "mcafee",
            "xss",
            "csrf",
            "sql injection",
            "shopping cart",
            "cms",
            "wordpress",
            "drupal",
            "joomla",
            "mambo",
            "imessage",
        ]

        relevant = []
        for exploit in exploits:
            title = (exploit.get("title") or "").lower()
            # Keep if NOT in noise keywords
            if not any(keyword in title for keyword in noise_keywords):
                relevant.append(exploit)

        return relevant

    def run_searchsploit_json(self, query: str) -> SearchsploitResult:
        """
        Runs: searchsploit --json -t <query>
        Uses -t flag to search titles only (cleaner results).

        Args:
            query (str): Service name/version (e.g., "OpenSSH 7.4" or "smb windows")

        Returns:
            SearchsploitResult
        """
        self._ensure_searchsploit_exists()

        # Use -t flag for title-only search (reduces noise significantly)
        cmd = ["searchsploit", "--json", "-t", query]
        command_str = " ".join(cmd)

        completed = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=self.timeout_sec,
        )

        stdout = completed.stdout or ""
        stderr = completed.stderr or ""

        # Try parsing JSON output
        try:
            raw_json = json.loads(stdout) if stdout.strip() else {}
        except json.JSONDecodeError:
            raw_json = {}

        return SearchsploitResult(
            command=command_str,
            raw_json=raw_json,
            stdout=stdout,
            stderr=stderr,
            exit_code=completed.returncode,
        )
