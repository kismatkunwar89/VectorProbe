
import json
import re
from dataclasses import dataclass
from typing import Dict, List

from utils.shell import execute_command
from utils.tool_checker import ensure_tool_exists


@dataclass
class SearchsploitResult:
    """
    Stores the result of a searchsploit command.
    """
    command: str
    raw_json: Dict
    stdout: str
    stderr: str
    exit_code: int


class VulnerabilityHandler:
    """
    Handles vulnerability lookup using searchsploit.
    Smart filtering to avoid noise (SSH clients, unrelated results).
    """

    def __init__(self, timeout_sec: int = 60):
        self.timeout_sec = timeout_sec

    def _filter_noise(self, exploits: List[Dict]) -> List[Dict]:
        """Filter out irrelevant SSH results (clients, unrelated CVEs)."""
        noise_keywords = [
            "client",
            "putty",
            "teraterm",
            "securecrt",
            "winscp",
            "filezilla",
            "chrome",
            "browser",
            "webmail",
            "google",
            "microsoft",
            "symantec",
            "kaspersky",
            "mcafee",
            "xss",
            "csrf",
            "sql injection",
            "shopping cart",
            "cms",
            "wordpress",
            "drupal",
            "joomla",
            "mambo",
            "imessage",
        ]

        relevant = []
        for exploit in exploits:
            title = (exploit.get("title") or "").lower()
            # Keep if NOT in noise keywords
            if not any(keyword in title for keyword in noise_keywords):
                relevant.append(exploit)

        return relevant

    def run_searchsploit_json(self, query: str) -> SearchsploitResult:
        """
        Runs: searchsploit --json -t <query>
        Uses -t flag to search titles only (cleaner results).

        Args:
            query (str): Service name/version (e.g., "OpenSSH 7.4" or "smb windows")

        Returns:
            SearchsploitResult
        """
        ensure_tool_exists("searchsploit", install_hint="Install from: https://www.exploit-db.com/searchsploit")

        # Use -t flag for title-only search (reduces noise significantly)
        cmd = ["searchsploit", "--json", "-t", query]

        result = execute_command(cmd, timeout=self.timeout_sec)
        stdout = result.stdout
        stderr = result.stderr
        command_str = result.command

        # Try parsing JSON output
        try:
            raw_json = json.loads(stdout) if stdout.strip() else {}
        except json.JSONDecodeError:
            raw_json = {}

        return SearchsploitResult(
            command=command_str,
            raw_json=raw_json,
            stdout=stdout,
            stderr=stderr,
            exit_code=result.exit_code,
        )
